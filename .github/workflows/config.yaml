name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '**' ]

jobs:
  checks:
    name: Checks (${{ matrix.module }})
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        module: ['client', 'web']
    defaults:
      run:
        working-directory: ${{ matrix.module }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache-dependency-path: ${{ matrix.module }}/go.sum
      - name: Vet
        run: CGO_ENABLED=0 go vet ./...
      - name: Staticcheck
        run: go tool staticcheck -checks=all ./...
      - name: Govulncheck
        run: go tool govulncheck ./...
      - name: Test
        run: CGO_ENABLED=1 go tool gotest -v -race -count=1 ./...

  e2e:
    name: E2E Integration
    needs: checks
    permissions:
      contents: read
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: e2e
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache-dependency-path: e2e/go.sum
      - name: Test
        run: CGO_ENABLED=1 go tool gotest -v -race -count=1 -tags=integration ./...
